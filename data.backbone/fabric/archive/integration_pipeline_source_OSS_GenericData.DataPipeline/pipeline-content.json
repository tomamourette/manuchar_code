{
  "properties": {
    "activities": [
      {
        "name": "lookup_integration_source_list",
        "type": "Lookup",
        "dependsOn": [],
        "policy": {
          "timeout": "0.12:00:00",
          "retry": 3,
          "retryIntervalInSeconds": 30,
          "secureOutput": false,
          "secureInput": false
        },
        "typeProperties": {
          "source": {
            "type": "DelimitedTextSource",
            "storeSettings": {
              "type": "LakehouseReadSettings",
              "recursive": true,
              "enablePartitionDiscovery": false
            },
            "formatSettings": {
              "type": "DelimitedTextReadSettings"
            }
          },
          "firstRowOnly": false,
          "datasetSettings": {
            "annotations": [],
            "linkedService": {
              "name": "0fa41da4_c7f0_4ac9_9c92_06979e72115e",
              "properties": {
                "annotations": [],
                "type": "Lakehouse",
                "typeProperties": {
                  "workspaceId": "@pipeline().DataFactory",
                  "artifactId": "@pipeline().parameters.integration_lakehouse",
                  "rootFolder": "Files"
                }
              }
            },
            "type": "DelimitedText",
            "typeProperties": {
              "location": {
                "type": "LakehouseLocation",
                "fileName": "integration_source_list.csv",
                "folderPath": {
                  "value": "integration/@{pipeline().parameters.source_name}",
                  "type": "Expression"
                }
              },
              "columnDelimiter": ",",
              "escapeChar": "\\",
              "firstRowAsHeader": true,
              "quoteChar": "\""
            },
            "schema": []
          }
        }
      },
      {
        "name": "integrate_source_list",
        "type": "ForEach",
        "dependsOn": [
          {
            "activity": "filter_integration_enabled",
            "dependencyConditions": [
              "Succeeded"
            ]
          },
          {
            "activity": "set_variable_source_connection_id",
            "dependencyConditions": [
              "Succeeded"
            ]
          },
          {
            "activity": "set_variable_monitoring_connection_id",
            "dependencyConditions": [
              "Succeeded"
            ]
          },
          {
            "activity": "set_variable_lakehouse_connection_id",
            "dependencyConditions": [
              "Succeeded"
            ]
          }
        ],
        "typeProperties": {
          "items": {
            "value": "@activity('filter_integration_enabled').output.value",
            "type": "Expression"
          },
          "isSequential": false,
          "activities": [
            {
              "name": "lookup_integration_source_watermark",
              "type": "Lookup",
              "dependsOn": [
                {
                  "activity": "lookup_integration_source_metadata",
                  "dependencyConditions": [
                    "Succeeded"
                  ]
                }
              ],
              "policy": {
                "timeout": "0.12:00:00",
                "retry": 3,
                "retryIntervalInSeconds": 30,
                "secureOutput": false,
                "secureInput": false
              },
              "typeProperties": {
                "source": {
                  "type": "AzureSqlSource",
                  "sqlReaderQuery": {
                    "value": "IF '@{activity('lookup_integration_source_metadata').output.firstRow.load_type}' = 'INCREMENTAL'\nBEGIN\n    SELECT \n        COALESCE(FORMAT(MAX([timestamp]), 'yyyy-MM-dd HH:mm:ss.fff'), '0000-00-00 00:00:00') AS watermark_date\n    FROM \n        [dbb_warehouse].[meta].[monitoring_integration]\n    WHERE \n        [table_name] = '@{item().table_name}' \n        AND [schema_name] = '@{item().schema_name}' \n        AND [source_name] = '@{pipeline().parameters.source_name}'\n        AND [status] = 'Succeeded'\nEND\nELSE\nBEGIN\n    SELECT TOP 1\n        '0000-00-00 00:00:00' AS watermark_date\n    FROM \n        [dbb_warehouse].[meta].[monitoring_integration]\nEND",
                    "type": "Expression"
                  },
                  "queryTimeout": "02:00:00",
                  "partitionOption": "None"
                },
                "datasetSettings": {
                  "annotations": [],
                  "type": "AzureSqlTable",
                  "schema": [],
                  "typeProperties": {
                    "database": "dbb_warehouse"
                  },
                  "externalReferences": {
                    "connection": "@variables('monitoring_connection_id')"
                  }
                }
              }
            },
            {
              "name": "integrate_source_table_fail",
              "type": "Fail",
              "dependsOn": [
                {
                  "activity": "integrate_source_table",
                  "dependencyConditions": [
                    "Failed"
                  ]
                }
              ],
              "typeProperties": {
                "message": {
                  "value": "@activity('integrate_source_table').output",
                  "type": "Expression"
                },
                "errorCode": "500"
              }
            },
            {
              "name": "integrate_source_table",
              "type": "Copy",
              "dependsOn": [
                {
                  "activity": "lookup_integration_source_watermark",
                  "dependencyConditions": [
                    "Succeeded"
                  ]
                }
              ],
              "policy": {
                "timeout": "0.12:00:00",
                "retry": 3,
                "retryIntervalInSeconds": 30,
                "secureOutput": false,
                "secureInput": false
              },
              "typeProperties": {
                "source": {
                  "type": "SqlServerSource",
                  "additionalColumns": [
                    {
                      "name": "ingestion_timestamp",
                      "value": {
                        "value": "@{formatDateTime(pipeline().parameters.ingestion_timestamp, 'yyyy-MM-dd HH:mm:ss.ffffff')}",
                        "type": "Expression"
                      }
                    }
                  ],
                  "sqlReaderQuery": {
                    "value": "@{if(\n    equals(activity('lookup_integration_source_watermark').output.firstRow.watermark_date,'0000-00-00 00:00:00'),\n    activity('lookup_integration_source_metadata').output.firstRow.query,\n    concat(\n        activity('lookup_integration_source_metadata').output.firstRow.query,\n        ' WHERE ',\n        activity('lookup_integration_source_metadata').output.firstRow.update_field,\n        ' >= ',\n        '''',\n        activity('lookup_integration_source_watermark').output.firstRow.watermark_date,\n        ''''\n    )\n)}",
                    "type": "Expression"
                  },
                  "queryTimeout": "02:00:00",
                  "partitionOption": "None",
                  "datasetSettings": {
                    "annotations": [],
                    "type": "SqlServerTable",
                    "schema": [],
                    "typeProperties": {
                      "database": {
                        "value": "@pipeline().parameters.database_name",
                        "type": "Expression"
                      }
                    },
                    "externalReferences": {
                      "connection": "@variables('source_connection_id')"
                    }
                  }
                },
                "sink": {
                  "type": "LakehouseTableSink",
                  "tableActionOption": {
                    "value": "@{if(equals(activity('lookup_integration_source_watermark').output.firstRow.watermark_date, '0000/00/00'), 'OverwriteSchema', 'Append')}",
                    "type": "Expression"
                  },
                  "upsertSettings": {},
                  "partitionOption": "None",
                  "datasetSettings": {
                    "annotations": [],
                    "linkedService": {
                      "name": "70bc67cc_c881_49e3_88e7_3f4d1c4bf57e",
                      "properties": {
                        "annotations": [],
                        "type": "Lakehouse",
                        "typeProperties": {
                          "workspaceId": "@pipeline().DataFactory",
                          "artifactId": "@pipeline().parameters.integration_lakehouse",
                          "rootFolder": "Tables"
                        }
                      }
                    },
                    "type": "LakehouseTable",
                    "schema": [],
                    "typeProperties": {
                      "schema": "dbo",
                      "table": {
                        "value": "@{pipeline().parameters.source_name}__@{item().schema_name}_@{item().table_name}",
                        "type": "Expression"
                      }
                    }
                  }
                },
                "enableStaging": false,
                "translator": {
                  "type": "TabularTranslator",
                  "typeConversion": true,
                  "typeConversionSettings": {
                    "allowDataTruncation": true,
                    "treatBooleanAsNumber": false
                  }
                }
              }
            },
            {
              "name": "lookup_integration_source_metadata",
              "type": "Lookup",
              "dependsOn": [],
              "policy": {
                "timeout": "0.12:00:00",
                "retry": 3,
                "retryIntervalInSeconds": 30,
                "secureOutput": false,
                "secureInput": false
              },
              "typeProperties": {
                "source": {
                  "type": "JsonSource",
                  "storeSettings": {
                    "type": "LakehouseReadSettings",
                    "recursive": true,
                    "enablePartitionDiscovery": false
                  },
                  "formatSettings": {
                    "type": "JsonReadSettings"
                  }
                },
                "datasetSettings": {
                  "annotations": [],
                  "linkedService": {
                    "name": "63435f1d_6951_45c2_bc99_669e0f6da47d",
                    "properties": {
                      "annotations": [],
                      "type": "Lakehouse",
                      "typeProperties": {
                        "workspaceId": "@{pipeline().DataFactory}",
                        "artifactId": "@pipeline().parameters.integration_lakehouse",
                        "rootFolder": "Files"
                      }
                    }
                  },
                  "type": "Json",
                  "typeProperties": {
                    "location": {
                      "type": "LakehouseLocation",
                      "fileName": {
                        "value": "@{item().table_name}.json",
                        "type": "Expression"
                      },
                      "folderPath": {
                        "value": "integration/@{pipeline().parameters.source_name}/@{item().schema_name}",
                        "type": "Expression"
                      }
                    }
                  },
                  "schema": {}
                }
              }
            },
            {
              "name": "script_monitoring_integration",
              "type": "Script",
              "dependsOn": [
                {
                  "activity": "integrate_source_table",
                  "dependencyConditions": [
                    "Completed"
                  ]
                }
              ],
              "policy": {
                "timeout": "0.12:00:00",
                "retry": 3,
                "retryIntervalInSeconds": 30,
                "secureOutput": false,
                "secureInput": false
              },
              "typeProperties": {
                "scripts": [
                  {
                    "type": "NonQuery",
                    "text": {
                      "value": "INSERT INTO [dbb_warehouse].[meta].[monitoring_integration] (\n    table_name,\n    schema_name,\n    source_name,\n    source_type,\n    load_type,\n    workspace,\n    status,\n    [timestamp],\n    duration,\n    throughput,\n    data_read,\n    data_written,\n    rows_read,\n    rows_written\n)\nVALUES (\n    '@{item().table_name}',\n    '@{item().schema_name}',\n    '@{pipeline().parameters.source_name}',\n    '@{activity('lookup_integration_source_metadata').output.firstRow.source_type}',\n    '@{activity('lookup_integration_source_metadata').output.firstRow.load_type}',\n    '@{pipeline().DataFactory}',\n    '@{activity('integrate_source_table').output.executionDetails[0].status}',\n    '@{formatDateTime(pipeline().parameters.ingestion_timestamp, 'yyyy-MM-dd HH:mm:ss.ffffff')}',\n    @{coalesce(activity('integrate_source_table').output.copyDuration, 0)},\n    @{coalesce(activity('integrate_source_table').output.throughput, 0)},\n    @{coalesce(activity('integrate_source_table').output.dataRead, 0)},\n    @{coalesce(activity('integrate_source_table').output.dataWritten, 0)},\n    @{coalesce(activity('integrate_source_table').output.rowsRead, 0)},\n    @{if(equals(activity('integrate_source_table').output.dataWritten, 0), 0, activity('integrate_source_table').output.rowsCopied)}\n);",
                      "type": "Expression"
                    }
                  }
                ],
                "scriptBlockExecutionTimeout": "02:00:00",
                "database": "dbb_warehouse"
              },
              "externalReferences": {
                "connection": "@variables('monitoring_connection_id')",
                "connectionType": "AzureSqlDatabase"
              }
            },
            {
              "name": "validate_integrate_source_table",
              "type": "Copy",
              "dependsOn": [
                {
                  "activity": "integrate_source_table",
                  "dependencyConditions": [
                    "Succeeded"
                  ]
                }
              ],
              "policy": {
                "timeout": "0.12:00:00",
                "retry": 3,
                "retryIntervalInSeconds": 30,
                "secureOutput": false,
                "secureInput": false
              },
              "typeProperties": {
                "source": {
                  "type": "AzureSqlSource",
                  "sqlReaderQuery": {
                    "value": "SELECT TOP 10 * FROM dbo.[@{pipeline().parameters.source_name}__@{item().schema_name}_@{item().table_name}]",
                    "type": "Expression"
                  },
                  "queryTimeout": "02:00:00",
                  "partitionOption": "None",
                  "datasetSettings": {
                    "annotations": [],
                    "type": "AzureSqlTable",
                    "schema": [],
                    "typeProperties": {
                      "database": "dbb_lakehouse"
                    },
                    "externalReferences": {
                      "connection": "@variables('lakehouse_connection_id')"
                    }
                  }
                },
                "sink": {
                  "type": "DelimitedTextSink",
                  "storeSettings": {
                    "type": "LakehouseWriteSettings"
                  },
                  "formatSettings": {
                    "type": "DelimitedTextWriteSettings",
                    "fileExtension": ".txt"
                  },
                  "datasetSettings": {
                    "annotations": [],
                    "linkedService": {
                      "name": "b941f9da_4d1d_43cd_ad7e_365f155ed00b",
                      "properties": {
                        "annotations": [],
                        "type": "Lakehouse",
                        "typeProperties": {
                          "workspaceId": "@pipeline().DataFactory",
                          "artifactId": "@pipeline().parameters.integration_lakehouse",
                          "rootFolder": "Files"
                        }
                      }
                    },
                    "type": "DelimitedText",
                    "typeProperties": {
                      "location": {
                        "type": "LakehouseLocation",
                        "fileName": {
                          "value": "validation_copy_data_@{pipeline().parameters.source_name}__@{item().schema_name}_@{item().table_name}_@{formatDateTime(utcnow(), 'yyyyMMddHHmmssffffff')}.csv",
                          "type": "Expression"
                        },
                        "folderPath": "monitoring/integration_validation"
                      },
                      "columnDelimiter": ",",
                      "escapeChar": "\\",
                      "firstRowAsHeader": true,
                      "quoteChar": "\""
                    },
                    "schema": []
                  }
                },
                "enableStaging": false,
                "translator": {
                  "type": "TabularTranslator",
                  "typeConversion": true,
                  "typeConversionSettings": {
                    "allowDataTruncation": true,
                    "treatBooleanAsNumber": false
                  }
                }
              }
            }
          ]
        }
      },
      {
        "name": "filter_integration_enabled",
        "type": "Filter",
        "dependsOn": [
          {
            "activity": "lookup_integration_source_list",
            "dependencyConditions": [
              "Succeeded"
            ]
          }
        ],
        "typeProperties": {
          "items": {
            "value": "@activity('lookup_integration_source_list').output.value",
            "type": "Expression"
          },
          "condition": {
            "value": "@equals(item().load_enabled,'yes')",
            "type": "Expression"
          }
        }
      },
      {
        "name": "lookup_integration_source_connections",
        "type": "Lookup",
        "dependsOn": [],
        "policy": {
          "timeout": "0.12:00:00",
          "retry": 3,
          "retryIntervalInSeconds": 30,
          "secureOutput": false,
          "secureInput": false
        },
        "typeProperties": {
          "source": {
            "type": "DelimitedTextSource",
            "storeSettings": {
              "type": "LakehouseReadSettings",
              "recursive": true,
              "enablePartitionDiscovery": false
            },
            "formatSettings": {
              "type": "DelimitedTextReadSettings"
            }
          },
          "firstRowOnly": false,
          "datasetSettings": {
            "annotations": [],
            "linkedService": {
              "name": "6217c080_aef9_4d02_b3ca_953f8533fbc5",
              "properties": {
                "annotations": [],
                "type": "Lakehouse",
                "typeProperties": {
                  "workspaceId": "@pipeline().DataFactory",
                  "artifactId": "@pipeline().parameters.integration_lakehouse",
                  "rootFolder": "Files"
                }
              }
            },
            "type": "DelimitedText",
            "typeProperties": {
              "location": {
                "type": "LakehouseLocation",
                "fileName": "integration_source_connections.csv",
                "folderPath": {
                  "value": "integration",
                  "type": "Expression"
                }
              },
              "columnDelimiter": ",",
              "escapeChar": "\\",
              "firstRowAsHeader": true,
              "quoteChar": "\""
            },
            "schema": []
          }
        }
      },
      {
        "name": "set_variable_source_connection_id",
        "type": "SetVariable",
        "dependsOn": [
          {
            "activity": "filter_source_connection",
            "dependencyConditions": [
              "Succeeded"
            ]
          }
        ],
        "policy": {
          "secureOutput": false,
          "secureInput": false
        },
        "typeProperties": {
          "variableName": "source_connection_id",
          "value": {
            "value": "@first(activity('filter_source_connection').output.value).connection_id\n\n",
            "type": "Expression"
          }
        }
      },
      {
        "name": "filter_source_connection",
        "type": "Filter",
        "dependsOn": [
          {
            "activity": "lookup_integration_source_connections",
            "dependencyConditions": [
              "Succeeded"
            ]
          }
        ],
        "typeProperties": {
          "items": {
            "value": "@activity('lookup_integration_source_connections').output.value",
            "type": "Expression"
          },
          "condition": {
            "value": "@and(\n  equals(item().source_name, pipeline().parameters.source_name),\n  equals(item().workspace_id, pipeline().DataFactory)\n)",
            "type": "Expression"
          }
        }
      },
      {
        "name": "filter_monitoring_connection",
        "type": "Filter",
        "dependsOn": [
          {
            "activity": "lookup_integration_source_connections",
            "dependencyConditions": [
              "Succeeded"
            ]
          }
        ],
        "typeProperties": {
          "items": {
            "value": "@activity('lookup_integration_source_connections').output.value",
            "type": "Expression"
          },
          "condition": {
            "value": "@and(\n  equals(item().source_name, 'dbb_warehouse'),\n  equals(item().workspace_id, pipeline().DataFactory)\n)",
            "type": "Expression"
          }
        }
      },
      {
        "name": "set_variable_monitoring_connection_id",
        "type": "SetVariable",
        "dependsOn": [
          {
            "activity": "filter_monitoring_connection",
            "dependencyConditions": [
              "Succeeded"
            ]
          }
        ],
        "policy": {
          "secureOutput": false,
          "secureInput": false
        },
        "typeProperties": {
          "variableName": "monitoring_connection_id",
          "value": {
            "value": "@first(activity('filter_monitoring_connection').output.value).connection_id\n\n",
            "type": "Expression"
          }
        }
      },
      {
        "name": "filter_lakehouse_connection",
        "type": "Filter",
        "dependsOn": [
          {
            "activity": "lookup_integration_source_connections",
            "dependencyConditions": [
              "Succeeded"
            ]
          }
        ],
        "typeProperties": {
          "items": {
            "value": "@activity('lookup_integration_source_connections').output.value",
            "type": "Expression"
          },
          "condition": {
            "value": "@and(\n  equals(item().source_name, 'dbb_lakehouse'),\n  equals(item().workspace_id, pipeline().DataFactory)\n)",
            "type": "Expression"
          }
        }
      },
      {
        "name": "set_variable_lakehouse_connection_id",
        "type": "SetVariable",
        "dependsOn": [
          {
            "activity": "filter_lakehouse_connection",
            "dependencyConditions": [
              "Succeeded"
            ]
          }
        ],
        "policy": {
          "secureOutput": false,
          "secureInput": false
        },
        "typeProperties": {
          "variableName": "lakehouse_connection_id",
          "value": {
            "value": "@first(activity('filter_lakehouse_connection').output.value).connection_id\n\n",
            "type": "Expression"
          }
        }
      }
    ],
    "parameters": {
      "source_name": {
        "type": "string",
        "defaultValue": "OSS_GenericData"
      },
      "database_name": {
        "type": "string",
        "defaultValue": "OSS_GenericData_MHQ_Warehouse"
      },
      "integration_lakehouse": {
        "type": "string",
        "defaultValue": "a3c7dd8f-25f9-4aa9-aaad-981087e7d0d4"
      },
      "ingestion_timestamp": {
        "type": "string",
        "defaultValue": "2025/07/18"
      }
    },
    "variables": {
      "source_connection_id": {
        "type": "String"
      },
      "monitoring_connection_id": {
        "type": "String"
      },
      "lakehouse_connection_id": {
        "type": "String"
      }
    }
  }
}